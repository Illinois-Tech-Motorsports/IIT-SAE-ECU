<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SAE Teensy ECU: X Macros</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="DoxyLogo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SAE Teensy ECU
   </div>
   <div id="projectbrief">IIT SAE Microcontroller programming</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('_x_macros.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">X Macros </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md16"></a>
X Macros</h1>
<p >This Page helps explain how <a href="https://www.geeksforgeeks.org/x-macros-in-c/">X Macros</a> are used in this project.</p>
<p >There are resources linked that can also explain their usage however this page hopes to explain their usage in this project.</p>
<p >The basic idea behind X Macros in this project is that, using the C preprocessor, we can essentially generate code by just using definitions.</p>
<h1><a class="anchor" id="XMacros_Creating_an_X_Macro"></a>
Creating an X Macro</h1>
<p >In this project, X Macros have two parts, the defining part, and the generating part.</p>
<h2><a class="anchor" id="XMacros_Defining"></a>
Defining</h2>
<p >The defining part mostly occurs in <code>.def</code> files, the X macro definition can look as such.</p>
<div class="fragment"><div class="line">#define NAME_OF_X_MACRO \</div>
<div class="line">X(45, &quot;Some String&quot;)    \</div>
<div class="line">X(67, &quot;Another string&quot;) \</div>
<div class="line">X(32, &quot;sTRiNg&quot;)</div>
</div><!-- fragment --><p >If you are inexperienced with macros, know that the <code>\</code> at the end of each line just means that this is a multi-line macro.</p>
<p >This means the final macro actually will look like this.</p>
<div class="fragment"><div class="line">#define NAME_OF_X_MACRO X(45, &quot;Some String&quot;) X(67, &quot;Another string&quot;) X(32, &quot;sTRiNg&quot;)</div>
</div><!-- fragment --><dl class="section warning"><dt>Warning</dt><dd>When making an X Macro multiline, you need to make sure that the last line does not have a <code>\</code>, as the <code>\</code> tells the preprocessor that there is another line it should append to the same define, just take note of that on the example <code>NAME_OF_X_MACRO</code>.</dd></dl>
<p>Each line after the define must call a non existent macro simply called <code>X</code>.</p>
<p >Technically it does not have to be called <code>X</code> but that is what this project uses.</p>
<p >Note that each line gives the same number of arguments and those arguments also are of the same data type respectively.</p>
<p >Using the right generating techniques, the number of arguments and their data types would not matter, however this project does do that.</p>
<h2><a class="anchor" id="XMacros_Generating"></a>
Generating</h2>
<p >Using <code>NAME_OF_X_MACRO</code>, we can interact with it's calls to <code>X</code> in many different ways.</p>
<p >We know that the first parameter of each macro is an integer, and the second a string. Say we want to log each of these macros. Using Log_t it would look as such.</p>
<div class="fragment"><div class="line">void printAll(){</div>
<div class="line">#define X(number, string) Log.i(&quot;ID&quot;, string, number);</div>
<div class="line">    NAME_OF_X_MACRO</div>
<div class="line">#undef X</div>
<div class="line">}</div>
</div><!-- fragment --><p >Note that we first define <code>X</code>, call the <code>NAME_OF_X_MACRO</code> macro, and then undefine <code>X</code> with <code>#undef</code>.</p>
<p >In the preprocessor, <code>NAME_OF_X_MACRO</code> will expand as follows.</p>
<div class="fragment"><div class="line">void printAll(){</div>
<div class="line">#define X(number, string) Log.i(&quot;ID&quot;, string, number);</div>
<div class="line">    X(45, &quot;Some String&quot;) </div>
<div class="line">    X(67, &quot;Another string&quot;)</div>
<div class="line">    X(32, &quot;sTRiNg&quot;)</div>
<div class="line">#undef X</div>
<div class="line">}</div>
</div><!-- fragment --><p >Because the macro <code>X</code> exists after we have defined it, each line will now expand to whatever X is as such.</p>
<div class="fragment"><div class="line">void printAll(){</div>
<div class="line">#define X(number, string) Log.i(&quot;ID&quot;, string, number);</div>
<div class="line">    Log.i(&quot;ID&quot;, &quot;Some String&quot;, 45);</div>
<div class="line">    Log.i(&quot;ID&quot;, &quot;Another string&quot;, 67);</div>
<div class="line">    Log.i(&quot;ID&quot;, &quot;sTRiNg&quot;, 32);</div>
<div class="line">#undef X</div>
<div class="line">}</div>
</div><!-- fragment --><p >So essentially, after the preprocessor, the final code before compilation will look like this. </p><div class="fragment"><div class="line">void printAll(){</div>
<div class="line">    Log.i(&quot;ID&quot;, &quot;Some String&quot;, 45);</div>
<div class="line">    Log.i(&quot;ID&quot;, &quot;Another string&quot;, 67);</div>
<div class="line">    Log.i(&quot;ID&quot;, &quot;sTRiNg&quot;, 32);</div>
<div class="line">}</div>
</div><!-- fragment --><p >And, as you can hopefully see, this means we can generate a lot of code using just some input parameters.</p>
<h1><a class="anchor" id="XMacros_Caveats"></a>
Caveats</h1>
<p >The following sections discuss generation techniques used in this project that may be confusing to some.</p>
<h2><a class="anchor" id="XMacros_XMacro_Counter"></a>
X Macro Counter</h2>
<p >One technique that is used throughout this project that may be confusing is this method of generation.</p>
<div class="fragment"><div class="line">#define X(...) ,</div>
<div class="line">static const int LOG_COUNT = PP_NARG_MO(NAME_OF_X_MACRO);</div>
<div class="line">#undef X</div>
</div><!-- fragment --><p >Using our previous definition of <code>NAME_OF_X_MACRO</code>, <code>LOG_COUNT</code> will expand to 3.</p>
<p >This is done by using the macro <code>PP_NARG_MO</code>, which simply counts how many parameters are passed to it. This macro is defined in <a class="el" href="_p_p_help_8h.html" title="Compilation of various helpful preprocessor macros.">PPHelp.h</a>.</p>
<p >However, to the preprocessor, each parameter technically does not need to actually exists, simply putting a <code>,</code> means that there is a parameter.</p>
<p >Therefore, the next expansion of <code>LOG_COUNT</code> would look as such</p>
<div class="fragment"><div class="line">#define X(...) ,</div>
<div class="line">static const int LOG_COUNT = PP_NARG_MO(,,,);</div>
<div class="line">#undef X</div>
</div><!-- fragment --><p >This tells the preprocessor that it should pass 4 arguments and <code>PP_NARG_MO</code> counts this. Also note, however, that we have three calls to <code>X</code>, not 4. There will always be one extra, so <code>PP_NARG_MO</code> ensures that it removes one each time this happens.</p>
<p >Note however of a limitation, <code>PP_NARG_MO</code> technically is not <em>counting</em>, the only thing one must know is that <code>PP_NARG_MO</code> currently has a limit of <code>64</code> parameters. This can be increased however I am too lazy and I also have not ran into any issues with this limit.</p>
<h2><a class="anchor" id="XMacros_Concatenated_Calls"></a>
Concatenated Calls</h2>
<p >Mainly used in <a class="el" href="_pins_8cpp.html" title="Pins source file.">Pins.cpp</a>, this generation method uses <a href="https://gcc.gnu.org/onlinedocs/gcc-3.0.1/cpp_3.html#SEC18">macro concatenation</a> to <em>build</em> the name of a function to then call it.</p>
<p >This example is part of the source code for <a class="el" href="namespace_pins.html#a5bb778c9151687c75d254d2fef4509fd" title="Get the pin value of a predefined pin.">Pins::getPinValue()</a></p>
<div class="fragment"><div class="line">0   #define __READPIN_DIGITALINPUT(PIN) \</div>
<div class="line">1       }                               \</div>
<div class="line">2       else if (GPIO_Pin == PIN) {     \</div>
<div class="line">3           return digitalReadFast(PIN);</div>
<div class="line">4   </div>
<div class="line">5   #define __READPIN_ANALOGINPUT(PIN) \</div>
<div class="line">6       }                              \</div>
<div class="line">7       else if (GPIO_Pin == PIN) {    \</div>
<div class="line">8           return analogRead(PIN);    \</div>
<div class="line">9   </div>
<div class="line">10  #define __READPIN_DIGITALOUTPUT(PIN)</div>
<div class="line">11  #define __READPIN_ANALOGOUTPUT(PIN)</div>
<div class="line">12  </div>
<div class="line">13  ...</div>
<div class="line">14  </div>
<div class="line">15  int getPinValue(uint8_t GPIO_Pin) {</div>
<div class="line">16      if (GPIO_Pin &gt;= 100) {</div>
<div class="line">17          return getCanPinValue(GPIO_Pin);</div>
<div class="line">18  #define X(pin, Type, IO, init) __READPIN_##Type##IO(pin);</div>
<div class="line">19          ECU_PINS</div>
<div class="line">20  #undef X</div>
<div class="line">21      } else {</div>
<div class="line">22  #ifdef CONF_ECU_DEBUG</div>
<div class="line">23          Log.d(ID, &quot;No pin defined&quot;, GPIO_Pin);</div>
<div class="line">24  #endif</div>
<div class="line">25          return 0;</div>
<div class="line">26      }</div>
<div class="line">27  }</div>
</div><!-- fragment --><p >Note that the <code>...</code> just means there is other code in between the parts we are looking at that we do not care about for now.</p>
<p >The main definition to take note of is <code>ECU_PINS</code> on line <code>19</code>.</p>
<p >the X Macro definition on line <code>18</code> takes in a pin number, a type, whether this pin is input or output, and the initial value of the pin.</p>
<p >An example call to <code>X</code> is as follows</p>
<div class="fragment"><div class="line">X(45, DIGITAL, INPUT, NIL)</div>
</div><!-- fragment --><p >Pin 45 will be read as digital input, with no initial value as it is input.</p>
<p >Out current definition of <code>X</code> at line <code>18</code> would interpret this as follows</p>
<div class="fragment"><div class="line">// Using X(pin, Type, IO, init) __READPIN_##Type##IO(pin);</div>
<div class="line">// Input X(45, DIGITAL, INPUT, NIL)</div>
<div class="line">__READPIN_DIGITALINPUT(45);</div>
</div><!-- fragment --><p >Which, looking at line <code>0</code>, would be expand to</p>
<div class="fragment"><div class="line">} else if (GPIO_Pin == PIN) {     </div>
<div class="line">    return digitalReadFast(PIN);</div>
</div><!-- fragment --><p >Where <a class="el" href="namespace_pins.html#a5bb778c9151687c75d254d2fef4509fd" title="Get the pin value of a predefined pin.">Pins::getPinValue()</a>, after the preprocessor, would end up looking like this</p>
<div class="fragment"><div class="line">int getPinValue(uint8_t GPIO_Pin) {</div>
<div class="line">    if (GPIO_Pin &gt;= 100) {</div>
<div class="line">        return getCanPinValue(GPIO_Pin);</div>
<div class="line">    } else if (GPIO_Pin == PIN) {     </div>
<div class="line">        return digitalReadFast(PIN);</div>
<div class="line">    } else {</div>
<div class="line">        return 0;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p >If our call to <code>X</code> was instead this</p>
<div class="fragment"><div class="line">X(10, ANALOG, OUTPUT, 0)</div>
</div><!-- fragment --><p >It would expand to <code>__READPIN_ANALOGOUTPUT(10)</code></p>
<p >However, because we do not read from output pins, <code>__READPIN_ANALOGOUTPUT()</code> is an empty macro, meaning nothing is done inside <a class="el" href="namespace_pins.html#a5bb778c9151687c75d254d2fef4509fd" title="Get the pin value of a predefined pin.">Pins::getPinValue()</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
